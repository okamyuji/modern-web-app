package templates

import (
	"fmt"
	"test-debug-demo/internal/models"
	"test-debug-demo/internal/middleware"
)

templ Base(title string, isDev bool) {
	<!DOCTYPE html>
	<html lang="ja" x-data="{ darkMode: false }" :class="{ 'dark': darkMode }">
		<head>
			<meta charset="UTF-8"/>
			<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
			<title>{ title }</title>
			<script src="https://unpkg.com/htmx.org@1.9.5"></script>
			<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
			<script src="https://cdn.tailwindcss.com"></script>
			<script>
				tailwind.config = {
					darkMode: 'class',
					theme: {
						extend: {
							colors: {
								primary: {
									50: '#eff6ff',
									500: '#3b82f6',
									600: '#2563eb',
									900: '#1e3a8a'
								}
							}
						}
					}
				}
			</script>
			if isDev {
				@templ.Raw(middleware.DevToolsCSS())
				@templ.Raw(middleware.HTMXDebugger())
			}
		</head>
		<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors">
			<nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
				<div class="container mx-auto px-4 py-4">
					<div class="flex justify-between items-center">
						<h1 class="text-2xl font-bold text-gray-900 dark:text-white">ãƒ†ã‚¹ãƒˆ&ãƒ‡ãƒãƒƒã‚°ãƒ‡ãƒ¢</h1>
						<div class="flex items-center space-x-4">
							<a href="/" class="text-blue-600 dark:text-blue-400 hover:underline">ãƒ›ãƒ¼ãƒ </a>
							<a href="/todos" class="text-blue-600 dark:text-blue-400 hover:underline">TODO</a>
							if isDev {
								<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">DEV</span>
							}
							<button 
								@click="darkMode = !darkMode"
								class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
							>
								<span x-show="!darkMode">ğŸŒ™</span>
								<span x-show="darkMode">â˜€ï¸</span>
							</button>
						</div>
					</div>
				</div>
			</nav>
			<main class="container mx-auto px-4 py-8">
				<div id="error-container"></div>
				{ children... }
			</main>
		</body>
	</html>
}

templ HomePage(todos []*models.Todo) {
	@Base("ãƒ†ã‚¹ãƒˆ&ãƒ‡ãƒãƒƒã‚°ãƒ‡ãƒ¢ - ãƒ›ãƒ¼ãƒ ", true) {
		<div class="max-w-4xl mx-auto">
			<div class="text-center mb-8">
				<h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">ç¬¬9ç« ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</h2>
				<p class="text-gray-600 dark:text-gray-400 text-lg">åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã¨ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ã®å®Ÿè£…ä¾‹</p>
			</div>

			<div class="grid md:grid-cols-2 gap-8 mb-8">
				<!-- ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ -->
				<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
					<div class="flex items-center mb-4">
						<div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center mr-4">
							<span class="text-2xl">ğŸ§ª</span>
						</div>
						<div>
							<h3 class="text-xl font-semibold text-gray-900 dark:text-white">ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½</h3>
							<p class="text-gray-600 dark:text-gray-400 text-sm">ãƒ¦ãƒ‹ãƒƒãƒˆãƒ»çµ±åˆãƒ»E2Eãƒ†ã‚¹ãƒˆ</p>
						</div>
					</div>
					<ul class="space-y-2 text-sm text-gray-600 dark:text-gray-300 mb-4">
						<li>âœ“ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ (testify)</li>
						<li>âœ“ HTTPãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ</li>
						<li>âœ“ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ</li>
						<li>âœ“ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ</li>
						<li>âœ“ E2Eãƒ†ã‚¹ãƒˆ</li>
					</ul>
					<button 
						onclick="runTests()"
						class="inline-block w-full text-center bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors"
					>
						ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
					</button>
				</div>

				<!-- ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ -->
				<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
					<div class="flex items-center mb-4">
						<div class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center mr-4">
							<span class="text-2xl">ğŸ›</span>
						</div>
						<div>
							<h3 class="text-xl font-semibold text-gray-900 dark:text-white">ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½</h3>
							<p class="text-gray-600 dark:text-gray-400 text-sm">é–‹ç™ºè€…å‘ã‘ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</p>
						</div>
					</div>
					<ul class="space-y-2 text-sm text-gray-600 dark:text-gray-300 mb-4">
						<li>âœ“ ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«</li>
						<li>âœ“ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–</li>
						<li>âœ“ ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹</li>
						<li>âœ“ HTMX/Alpine.jsãƒ‡ãƒãƒƒã‚°</li>
						<li>âœ“ æ§‹é€ åŒ–ãƒ­ã‚°</li>
					</ul>
					<button 
						onclick="toggleDebugMode()"
						class="inline-block w-full text-center bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors"
					>
						ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
					</button>
				</div>
			</div>

			<!-- TODOç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
			<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
				<h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">TODOã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</h3>
				<p class="text-gray-600 dark:text-gray-400 mb-6">å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™</p>
				
				<!-- TODOä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
				<form 
					hx-post="/todos"
					hx-target="#todo-list"
					hx-swap="beforeend"
					class="mb-6"
				>
					<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
						<input 
							type="text" 
							name="title" 
							placeholder="TODOã‚¿ã‚¤ãƒˆãƒ«"
							class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
							required
						/>
						<input 
							type="text" 
							name="description" 
							placeholder="èª¬æ˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
							class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
						/>
						<select 
							name="priority"
							class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
						>
							<option value="low">ä½</option>
							<option value="medium" selected>ä¸­</option>
							<option value="high">é«˜</option>
						</select>
						<button 
							type="submit"
							class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors"
						>
							è¿½åŠ 
						</button>
					</div>
				</form>

				<!-- TODOãƒªã‚¹ãƒˆ -->
				<div id="todo-list" class="space-y-3">
					@TodoList(todos)
				</div>
			</div>

			<!-- ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º -->
			<div class="mt-8 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
				<h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹</h3>
				<div 
					id="metrics"
					hx-get="/metrics"
					hx-trigger="every 5s"
					hx-swap="innerHTML"
				>
					ãƒ¡ãƒˆãƒªã‚¯ã‚¹èª­ã¿è¾¼ã¿ä¸­...
				</div>
			</div>
		</div>

		<script>
		function runTests() {
			alert('ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚\ngo test ./... -v\nã‚³ãƒãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
		}

		function toggleDebugMode() {
			const debugPanels = document.querySelectorAll('#debug-panel, .debug-info');
			debugPanels.forEach(panel => {
				panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
			});
		}

		// HTMXã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
		document.body.addEventListener('htmx:afterRequest', function(evt) {
			if (evt.detail.xhr.status >= 400) {
				console.error('HTMX Request failed:', evt.detail);
			}
		});
		</script>
	}
}

templ TodoList(todos []*models.Todo) {
	for _, todo := range todos {
		@TodoItem(todo)
	}
	if len(todos) == 0 {
		<div class="text-center py-8 text-gray-500 dark:text-gray-400">
			TODOãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
		</div>
	}
}

templ TodoItem(todo *models.Todo) {
	<div 
		class="flex items-center justify-between p-4 border rounded-lg"
		class={ getPriorityClass(todo.Priority) }
		data-todo-id={ fmt.Sprintf("%d", todo.ID) }
		x-data="{ editing: false }"
	>
		<div class="flex items-center space-x-3 flex-1">
			<input 
				type="checkbox"
				checked?={ todo.Completed }
				hx-patch={ fmt.Sprintf("/todos/%d/toggle", todo.ID) }
				hx-target={ fmt.Sprintf("[data-todo-id='%d']", todo.ID) }
				hx-swap="outerHTML"
				class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
			/>
			<div class="flex-1">
				<h4 class={ "font-medium", templ.KV("line-through text-gray-500", todo.Completed), templ.KV("text-gray-900 dark:text-white", !todo.Completed) }>
					{ todo.Title }
				</h4>
				if todo.Description != "" {
					<p class="text-sm text-gray-600 dark:text-gray-400">{ todo.Description }</p>
				}
				<div class="flex items-center space-x-2 text-xs text-gray-500 dark:text-gray-400 mt-1">
					<span>å„ªå…ˆåº¦: { getPriorityText(todo.Priority) }</span>
					<span>â€¢</span>
					<span>{ todo.CreatedAt.Format("2006/01/02 15:04") }</span>
				</div>
			</div>
		</div>
		<div class="flex items-center space-x-2">
			<button 
				x-show="!editing"
				@click="editing = true"
				class="text-blue-600 hover:text-blue-800 text-sm"
			>
				ç·¨é›†
			</button>
			<button 
				hx-delete={ fmt.Sprintf("/todos/%d", todo.ID) }
				hx-target={ fmt.Sprintf("[data-todo-id='%d']", todo.ID) }
				hx-swap="outerHTML"
				hx-confirm="æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"
				class="text-red-600 hover:text-red-800 text-sm"
			>
				å‰Šé™¤
			</button>
		</div>
	</div>
}

templ ValidationErrors(errors []string) {
	<div class="bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-700 rounded-lg p-4 mb-4">
		<h4 class="text-red-800 dark:text-red-200 font-semibold mb-2">å…¥åŠ›ã‚¨ãƒ©ãƒ¼</h4>
		<ul class="list-disc list-inside space-y-1">
			for _, error := range errors {
				<li class="text-red-700 dark:text-red-300 text-sm">{ error }</li>
			}
		</ul>
	</div>
}

templ MetricsDisplay(metrics map[string]interface{}) {
	<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
		<div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg">
			<div class="text-2xl font-bold text-blue-600 dark:text-blue-400">
				{ fmt.Sprintf("%v", metrics["request_count"]) }
			</div>
			<div class="text-sm text-blue-500 dark:text-blue-300">ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°</div>
		</div>
		<div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg">
			<div class="text-2xl font-bold text-red-600 dark:text-red-400">
				{ fmt.Sprintf("%v", metrics["error_count"]) }
			</div>
			<div class="text-sm text-red-500 dark:text-red-300">ã‚¨ãƒ©ãƒ¼æ•°</div>
		</div>
		<div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg">
			<div class="text-2xl font-bold text-green-600 dark:text-green-400">
				{ fmt.Sprintf("%v", metrics["avg_duration_ms"]) }
			</div>
			<div class="text-sm text-green-500 dark:text-green-300">å¹³å‡å‡¦ç†æ™‚é–“(ms)</div>
		</div>
		<div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg">
			<div class="text-2xl font-bold text-purple-600 dark:text-purple-400">
				{ fmt.Sprintf("%v", metrics["active_requests"]) }
			</div>
			<div class="text-sm text-purple-500 dark:text-purple-300">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</div>
		</div>
	</div>
	<div class="mt-4 text-sm text-gray-600 dark:text-gray-400">
		<div>ã‚¨ãƒ©ãƒ¼ç‡: { fmt.Sprintf("%v", metrics["error_rate"]) }</div>
		<div>ç´¯è¨ˆå‡¦ç†æ™‚é–“: { fmt.Sprintf("%.2f", metrics["total_duration_ms"]) }ms</div>
	</div>
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
func getPriorityClass(priority string) string {
	switch priority {
	case "high":
		return "bg-red-50 dark:bg-red-900 border-red-200 dark:border-red-700"
	case "medium":
		return "bg-yellow-50 dark:bg-yellow-900 border-yellow-200 dark:border-yellow-700"
	case "low":
		return "bg-green-50 dark:bg-green-900 border-green-200 dark:border-green-700"
	default:
		return "bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700"
	}
}

func getPriorityText(priority string) string {
	switch priority {
	case "high":
		return "é«˜"
	case "medium":
		return "ä¸­"
	case "low":
		return "ä½"
	default:
		return "ä¸æ˜"
	}
}